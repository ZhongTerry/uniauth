{% extends "base.html" %}

{% block content %}
<style>
    /* 简单的 Tab 切换样式 */
    .auth-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 20px; }
    .auth-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #666; font-weight: 500; }
    .auth-tab.active { color: #007bff; border-bottom: 2px solid #007bff; }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    
    /* 验证码行样式 */
    .verify-row { display: flex; gap: 10px; }
    .verify-btn { white-space: nowrap; font-size: 13px; }
</style>

<div class="auth-box card" style="max-width: 420px;">
    <div style="text-align: center; margin-bottom: 10px;">
        <h2 style="margin: 0; color: var(--text-main);">UniAuth</h2>
        <p style="color: #666; font-size: 13px;">统一身份认证平台</p>
    </div>

    <!-- Tabs -->
    <div class="auth-tabs">
        <div class="auth-tab {% if mode == 'login' %}active{% endif %}" onclick="switchTab('login')">登录</div>
        <div class="auth-tab {% if mode == 'register' %}active{% endif %}" onclick="switchTab('register')">注册</div>
    </div>

    <!-- 登录表单 -->
    <div id="form-login" class="auth-form {% if mode == 'login' %}active{% endif %}">
        <form action="/login" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if redirect_uri %}
            <input type="hidden" name="redirect_uri" value="{{ redirect_uri }}">
            {% endif %}
            
            <div class="input-group">
                <label>用户名</label>
                <input type="text" name="username" required placeholder="请输入用户名">
            </div>
            <div class="input-group">
                <label>密码</label>
                <input type="password" name="password" required placeholder="请输入密码">
            </div>
            <div style="text-align: right; margin-bottom: 15px;">
                <a href="/forgot-password" style="font-size: 12px; color: #666;">忘记密码?</a>
            </div>
            <button type="submit" class="btn btn-primary btn-block">立即登录</button>
        </form>
    </div>

    <!-- 注册表单 (包含复杂验证) -->
    <div id="form-register" class="auth-form {% if mode == 'register' %}active{% endif %}">
        <form action="/register" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if redirect_uri %}
            <input type="hidden" name="redirect_uri" value="{{ redirect_uri }}">
            {% endif %}

            <div class="input-group">
                <label>用户名</label>
                <input type="text" name="username" required placeholder="设置用户名">
            </div>
            <div class="input-group">
                <label>密码</label>
                <input type="password" name="password" required placeholder="设置密码 (建议复杂点)">
            </div>
            
            <div class="input-group">
                <label>国内邮箱 (QQ/163/Sina等)</label>
                <input type="email" id="reg-email" name="email" required placeholder="例如: 123456@qq.com">
            </div>

            <!-- 图片验证码 (第一道防线) -->
            <div class="input-group">
                <label>图片验证码 (防刷)</label>
                <div class="verify-row">
                    <input type="text" id="img-code-input" placeholder="输入右侧字符" style="width: 120px;">
                    <img src="/captcha" id="captcha-img" onclick="this.src='/captcha?'+Math.random()" style="cursor:pointer; height:42px; border-radius:4px; border:1px solid #ddd;" title="看不清？点击刷新">
                </div>
            </div>

            <!-- 邮件验证码 (第二道防线) -->
            <div class="input-group">
                <label>邮件验证码</label>
                <div class="verify-row">
                    <input type="text" name="code" required placeholder="6位数字">
                    <button type="button" id="send-btn" class="btn btn-ghost verify-btn" onclick="sendEmailCode()">获取验证码</button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">立即注册</button>
        </form>
    </div>
</div>

<script>
    function switchTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(el => el.classList.remove('active'));
        
        // 找到对应的Tab和Form激活
        // 这里简单粗暴匹配文本
        const tabs = document.querySelectorAll('.auth-tab');
        if(tab === 'login') { tabs[0].classList.add('active'); document.getElementById('form-login').classList.add('active'); }
        else { tabs[1].classList.add('active'); document.getElementById('form-register').classList.add('active'); }
    }

    function sendEmailCode() {
        const email = document.getElementById('reg-email').value;
        const imgCode = document.getElementById('img-code-input').value;
        const btn = document.getElementById('send-btn');
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;

        if(!email) { alert("请先输入邮箱"); return; }
        if(!imgCode) { alert("请先输入图片验证码"); return; }

        btn.disabled = true;
        btn.innerText = "发送中...";

        fetch('/send-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken // Flask-WTF 需要这个头
            },
            body: `email=${encodeURIComponent(email)}&img_code=${encodeURIComponent(imgCode)}`
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                alert("✅ " + data.message);
                let count = 60;
                const timer = setInterval(() => {
                    btn.innerText = `${count}s 后重发`;
                    count--;
                    if(count < 0) {
                        clearInterval(timer);
                        btn.disabled = false;
                        btn.innerText = "获取验证码";
                    }
                }, 1000);
            } else {
                alert("❌ " + data.message);
                btn.disabled = false;
                btn.innerText = "获取验证码";
                // 刷新验证码防止暴力破解
                document.getElementById('captcha-img').click();
                document.getElementById('img-code-input').value = '';
            }
        })
        .catch(err => {
            alert("❌ 网络错误");
            btn.disabled = false;
            btn.innerText = "获取验证码";
        });
    }
</script>
{% endblock %}