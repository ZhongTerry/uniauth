{% extends "base.html" %}

{% block content %}
<style>
    /* === é¡µé¢ä¸“å±æ ·å¼ === */
    
    /* å¼¹çª—é®ç½© */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        backdrop-filter: blur(3px);
    }
    
    /* å¼¹çª—ä¸»ä½“ */
    .modal-card {
        background: white; width: 90%; max-width: 500px; padding: 30px;
        border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: popIn 0.2s ease-out;
    }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    /* æ“ä½œå°æŒ‰é’® */
    .action-btn { 
        cursor: pointer; font-size: 12px; padding: 4px 8px; 
        border-radius: 4px; border: 1px solid #ddd; 
        background: white; color: #555; text-decoration: none; 
        display: inline-flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .action-btn:hover { background: #f8f9fa; color: #333; transform: translateY(-1px); }
    
    .btn-del:hover { background: #dc3545; color: white; border-color: #dc3545; }
    
    .btn-manage { 
        background: #e7f1ff; color: #007bff; border: 1px solid #b3d7ff; font-weight: 500;
    }
    .btn-manage:hover { background: #007bff; color: white; border-color: #007bff; }

    /* ç”¨æˆ·ä¿¡æ¯ */
    .user-profile-link { 
        display:flex; align-items:center; gap:10px; 
        text-decoration: none; color: #333; 
        padding: 6px 12px; border-radius: 30px; 
        transition: background 0.2s; border: 1px solid transparent;
    }
    .user-profile-link:hover { 
        background: white; border-color: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }

    /* === [æ–°å¢] å¤åˆ¶ç»„åˆæ¡†æ ·å¼ (æ–¹æ¡ˆB) === */
    .copy-input-group {
        display: flex;
        align-items: center;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background-color: #f8f9fa; /* é»˜è®¤ç°è‰²èƒŒæ™¯ï¼Œæš—ç¤ºåªè¯» */
        overflow: hidden;
        transition: border-color 0.2s;
    }
    .copy-input-group:hover {
        border-color: #b3b3b3;
    }
    .copy-input-group input {
        border: none;
        box-shadow: none;
        background: transparent;
        flex: 1; /* æ’‘æ»¡å‰©ä½™ç©ºé—´ */
        padding: 10px;
        font-family: monospace; /* ç­‰å®½å­—ä½“ */
        font-size: 13px;
        color: #555;
        outline: none;
        cursor: text; /* å…è®¸é€‰ä¸­æ–‡æœ¬ */
    }
    .copy-btn-icon {
        border: none;
        border-left: 1px solid #dee2e6;
        background: white;
        color: #666;
        width: 40px; /* å›ºå®šå®½åº¦ */
        align-self: stretch; /* é«˜åº¦æ‹‰ä¼¸ */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 16px;
    }
    .copy-btn-icon:hover {
        background: #f0f0f0;
        color: #007bff;
    }
    .copy-btn-icon:active {
        background: #e2e6ea;
    }
</style>

<div class="header-row">
    <div>
        <h2 style="margin:0;">å¼€å‘è€…ä»ªè¡¨ç›˜</h2>
        <p style="margin:5px 0 0 0; color:#666; font-size:14px;">ç®¡ç†æ‚¨çš„ OAuth åº”ç”¨</p>
    </div>
    
    <a href="/profile" class="user-profile-link" title="ç‚¹å‡»ä¿®æ”¹èµ„æ–™">
        <img src="{{ user.avatar }}" style="width:32px; height:32px; border-radius:50%; object-fit: cover;">
        <span style="font-weight:bold; font-size: 14px;">{{ user.username }}</span>
        <span style="color:#999; font-size: 12px;">âš™ï¸</span>
    </a>
    <div style="display:flex; align-items:center; gap:15px;">
        
        <a href="/stats" style="
        text-decoration: none; background: #e9ecef; color: #555; 
        padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;
        display: flex; align-items: center; gap: 5px;">
        ğŸŒ å…¨ç«™æ•°æ®
    </a>

    <!-- ç®¡ç†å‘˜å…¥å£ (ä»… Admin å¯è§) -->
    {% if user.is_admin %}
    <a href="/admin/stats" style="
        text-decoration: none; background: #222; color: #ffd700; 
        padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;
        display: flex; align-items: center; gap: 5px;">
        ğŸ›¡ï¸ ç®¡ç†åå°
    </a>
    {% endif %}

        <!-- ç”¨æˆ·ä¿¡æ¯é“¾æ¥ (ä¿æŒä¸å˜) -->
        <a href="/profile" class="user-profile-link" ...>...</a>
    </div>
</div>

<!-- åˆ›å»ºæ–°åº”ç”¨åŒºåŸŸ -->
<div class="card">
    <h3 style="margin-top:0; font-size:16px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px;">
        ğŸš€ åˆ›å»ºæ–°åº”ç”¨
    </h3>
    <form action="/apps/new" method="POST" style="display:flex; gap:15px; flex-wrap:wrap; align-items:flex-end;">
        <div style="flex:1; min-width:200px;">
            <label>åº”ç”¨åç§°</label>
            <input type="text" name="name" placeholder="ä¾‹å¦‚: My Awesome Blog" required>
        </div>
        <div style="flex:2; min-width:300px;">
            <label>å›è°ƒåœ°å€ (Callback URL)</label>
            <input type="text" name="redirect_uri" placeholder="http://127.0.0.1:8000/callback" required>
        </div>
        <button type="submit" class="btn btn-primary" style="height:42px; min-width: 100px;">åˆ›å»º App</button>
    </form>
</div>

<!-- åº”ç”¨åˆ—è¡¨åŒºåŸŸ -->
<h3 style="color:#555; margin-left:5px; margin-top: 30px;">æˆ‘çš„åº”ç”¨åˆ—è¡¨</h3>
<div class="grid-apps">
    {% for app in apps %}
    <div class="card" style="margin-bottom:0; display:flex; flex-direction:column; transition: transform 0.2s; position: relative;">
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
            <div style="font-weight:bold; font-size:18px; color: var(--text-main);">
                <a href="/apps/{{ app.client_id }}" style="text-decoration:none; color:inherit;">{{ app.name }}</a>
            </div>
            
            <div style="display:flex; gap:5px;">
                <a href="/apps/{{ app.client_id }}" class="action-btn btn-manage" target="_blank" title="æŸ¥çœ‹è¯¦æƒ…ä¸ç»Ÿè®¡">ğŸ“Š ç®¡ç†</a>
                
                <button type="button" class="action-btn" 
                    onclick="openEditModal('{{ app.client_id }}', '{{ app.name }}', '{{ app.redirect_uri }}')"
                    title="å¿«é€Ÿä¿®æ”¹å›è°ƒåœ°å€">âœ</button>
                
                <form action="/apps/{{ app.client_id }}/delete" method="POST" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåº”ç”¨å—ï¼Ÿ');" style="margin:0;">
                    <button type="submit" class="action-btn btn-del" title="åˆ é™¤åº”ç”¨">ğŸ—‘ï¸</button>
                </form>
            </div>
        </div>
        
        <!-- å¡ç‰‡ä¸»ä½“ï¼šClient ID / Secret (ä½¿ç”¨æ–¹æ¡ˆBæ ·å¼) -->
        <div class="input-group">
            <label>Client ID</label>
            <div class="copy-input-group">
                <input type="text" value="{{ app.client_id }}" readonly>
                <button type="button" class="copy-btn-icon" onclick="copyToClipboard(this.previousElementSibling)" title="å¤åˆ¶ ID">ğŸ“‹</button>
            </div>
        </div>
        <div class="input-group">
            <label>Client Secret</label>
            <div class="copy-input-group">
                <input type="text" value="{{ app.client_secret }}" readonly>
                <button type="button" class="copy-btn-icon" onclick="copyToClipboard(this.previousElementSibling)" title="å¤åˆ¶ Secret">ğŸ“‹</button>
            </div>
        </div>
        
        <!-- å¡ç‰‡åº•éƒ¨ -->
        <div style="margin-top:auto; padding-top:10px; border-top:1px solid #eee;">
            <label style="font-size:11px; color:#999;">å›è°ƒåœ°å€:</label>
            <div style="font-size:13px; color:#555; word-break:break-all; font-family: monospace;">
                {{ app.redirect_uri }}
            </div>
        </div>
    </div>
    {% else %}
    <div style="grid-column: 1/-1; text-align:center; padding:60px 20px; color:#999; border: 2px dashed #eee; border-radius: 10px;">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“­</div>
        <div>æš‚æ— åº”ç”¨ï¼Œè¯·åœ¨ä¸Šæ–¹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ª OAuth åº”ç”¨ã€‚</div>
    </div>
    {% endfor %}
</div>

<!-- ç¼–è¾‘åº”ç”¨çš„å¼¹çª— -->
<div id="editModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
            âœ ç¼–è¾‘åº”ç”¨ä¿¡æ¯
        </h3>
        <form id="editForm" method="POST">
            <div class="input-group">
                <label>åº”ç”¨åç§°</label>
                <input type="text" name="name" id="editName" required>
            </div>
            <div class="input-group">
                <label>å›è°ƒåœ°å€ (Redirect URI)</label>
                <input type="text" name="redirect_uri" id="editRedirectUri" required>
                <p style="font-size:12px; color:#999; margin-top:5px; line-height: 1.5;">
                    âš ï¸ æ³¨æ„ï¼šä¿®æ”¹æ­¤é¡¹åï¼Œè¯·ç¡®ä¿æ‚¨çš„å®¢æˆ·ç«¯ä»£ç åŒæ­¥æ›´æ–°ã€‚
                </p>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px;">
                <button type="button" class="btn btn-ghost" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModal(clientId, name, redirectUri) {
        document.getElementById('editName').value = name;
        document.getElementById('editRedirectUri').value = redirectUri;
        document.getElementById('editForm').action = '/apps/' + clientId + '/update';
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });
</script>
{% endblock %}