{% extends "base.html" %}

{% block content %}
<div class="header-row">
    <div>
        <a href="/dashboard" style="text-decoration: none; color: #666; font-size: 14px;">â† è¿”å›ä»ªè¡¨ç›˜</a>
        <h2 style="margin: 5px 0;">ä¸ªäººè®¾ç½®</h2>
    </div>
</div>
<!-- [æ–°å¢] æˆæƒç®¡ç†å…¥å£å¡ç‰‡ -->
<div class="card" style="max-width: 600px; margin: 0 auto 20px auto; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #e9ecef;">
    <div>
        <h4 style="margin: 0 0 5px 0;">å·²æˆæƒçš„åº”ç”¨</h4>
        <p style="margin: 0; font-size: 12px; color: #666;">æŸ¥çœ‹å¹¶ç®¡ç†æ‚¨å¯ä»¥è®¿é—®è´¦å·ä¿¡æ¯çš„ç¬¬ä¸‰æ–¹åº”ç”¨</p>
    </div>
    <a href="/settings/authorized" class="btn" style="background: white; color: #333; border: 1px solid #ddd; font-size: 13px;">
        ç®¡ç†æˆæƒ â†’
    </a>
</div>
<div class="card" style="max-width: 600px; margin: 0 auto;">
    <h3 style="margin-top:0; margin-bottom: 20px;">ğŸ‘¤ åŸºç¡€èµ„æ–™</h3>
    
    <!-- [å…³é”®] å¿…é¡»æ·»åŠ  enctype="multipart/form-data" -->
    <form method="POST" enctype="multipart/form-data" style="margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 30px;">
        <input type="hidden" name="action" value="update_info">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- å¤´åƒä¸Šä¼ åŒº -->
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="position: relative; display: inline-block; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                <img src="{{ user.avatar }}" id="avatarPreview" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #eee; object-fit: cover; transition: 0.2s;">
                <!-- é®ç½©æç¤º -->
                <div style="position: absolute; bottom: 0; right: 0; background: #007bff; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                    ğŸ“·
                </div>
            </div>
            <p style="font-size: 12px; color: #999; margin-top: 5px;">ç‚¹å‡»å¤´åƒä¸Šä¼ å›¾ç‰‡ (æœ€å¤§ 2MB)</p>
            
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
            <input type="file" name="avatar_file" id="fileInput" accept="image/*" style="display: none;" onchange="previewImage(this)">
        </div>

        <div class="input-group">
            <label>å¤´åƒé“¾æ¥ (ä¹Ÿå¯ä»¥ç›´æ¥å¡« URL)</label>
            <input type="text" name="avatar_url" id="urlInput" value="{{ user.avatar }}" placeholder="https://..." oninput="document.getElementById('avatarPreview').src = this.value">
        </div>

        <!-- å…¶ä»–èµ„æ–™ (ä¿æŒä¸å˜) -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="input-group">
                <label>ç”¨æˆ·å (ä¸å¯ä¿®)</label>
                <input type="text" value="{{ user.username }}" disabled style="background:#f8f9fa; cursor: not-allowed;">
            </div>
            <div class="input-group">
                <label>é‚®ç®± (ç™»å½•å‡­è¯)</label>
                <input type="text" value="{{ user.email }}" disabled style="background:#f8f9fa; cursor: not-allowed;">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="input-group">
                <label>æ‰‹æœºå· (é€‰å¡«)</label>
                <input type="text" name="phone" value="{{ user.phone or '' }}" placeholder="ä»…æˆæƒçš„åº”ç”¨å¯è§">
            </div>
            <div class="input-group">
                <label>ç”Ÿæ—¥ (é€‰å¡«)</label>
                <input type="date" name="birthday" value="{{ user.birthday or '' }}">
            </div>
        </div>

        <div class="input-group">
            <label>ä¸ªäººç®€ä»‹ (é€‰å¡«)</label>
            <textarea name="bio" rows="3" placeholder="ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±..." style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; font-family:inherit;">{{ user.bio or '' }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary btn-block">ä¿å­˜èµ„æ–™</button>
    </form>

    <!-- å¯†ç ä¿®æ”¹éƒ¨åˆ† (ä¿æŒä¸å˜) -->
    <h3>ğŸ”’ å®‰å…¨è®¾ç½®</h3>
    <form method="POST">
        <input type="hidden" name="action" value="update_password">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="input-group">
            <label>å½“å‰å¯†ç </label>
            <input type="password" name="old_password" required placeholder="è¯·è¾“å…¥æ—§å¯†ç ">
        </div>
        <div class="input-group">
            <label>æ–°å¯†ç </label>
            <input type="password" name="new_password" required placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
        </div>
        <div class="input-group">
            <label>ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" name="confirm_password" required placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
        <button type="submit" class="btn btn-ghost btn-block">æ›´æ–°å¯†ç </button>
    </form>
</div>

<script>
    // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆé€»è¾‘
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
                // æ¸…ç©º URL è¾“å…¥æ¡†ï¼Œé¿å…æ··æ·†
                document.getElementById('urlInput').value = ''; 
                document.getElementById('urlInput').placeholder = "å·²é€‰æ‹©æœ¬åœ°æ–‡ä»¶...";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}